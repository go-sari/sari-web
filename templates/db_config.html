{% extends "bootstrap/base.html" %}
{% block styles %}
    {{ super() }}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/css/bootstrap-select.min.css">
{% endblock %}
{% block content %}
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1 class="display-5">SARI Web</h1>
            <p class="lead">Get the configuration parameters to access an RDS instance.</p>
            <form class="form-inline">
                <div class="row align-items-end">
                    <div class="col-md d-flex flex-column col-form-label-sm align-items-start">
                        <label for="region">AWS Region:</label>
                        <select id="region" class="form-control" data-width="auto">
                        </select>
                    </div>
                    <div class="col-md d-flex flex-column col-form-label-sm align-items-start">
                        <label for="db_id">DB Identifier:</label>
                        <select id="db_id" class="form-control" data-live-search="true" data-size="10"
                                data-width="auto">
                        </select>
                    </div>
                    <div class="col-md col-form-label-sm">
                        <button id="get_config" type="button" class="btn btn-outline-success form-control">Get
                            Configuration
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <form >
            {% for width, label, id_ in [
            (3, "SSH Hostname", "bh_hostname"),
            (3, "SSH Username", "bh_username"),
            (6, "RDS Hostname", "rds_hostname"),
            (2, "RDS Server Port", "rds_port"),
            (4, "Username", "rds_username"),
            (10, "Password", "rds_password"),
            (3, "Database", "db_name"),
            ] %}
                <div class="form-group row">
                    <label for="{{ id_ }}" class="col-sm-2 col-form-label font-weight-bold px-0 text-right">{{ label }}</label>

                    <div class="col-sm-{{ width }}">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control d-inline-block text-truncate" id="{{ id_ }}" readonly>
                            <button type="button" class="btn" data-clipboard-target="#{{ id_ }}">
                                <img src="/static/assets/clippy.svg" width="13" alt="Copy to clipboard">
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </form>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
    <script>
        let databases = null;

        let clipboard = new ClipboardJS('.btn');
        clipboard.on("success", function (e) {
            e.clearSelection();
        })

        $(document).ready(function () {
            $.getJSON("/v1/databases", function (databases_) {
                databases = databases_;
                fill_select_picker("#region", Object.keys(databases));
                fill_select_picker("#db_id", databases[$("#region").val()]);
            })
        })

        $("#region").change(function () {
            if (databases != null) {
                fill_select_picker("#db_id", databases[$("#region").val()]);
            }
        })

        $("#get_config").click(function () {
            let region = $("#region").val();
            let db_id = $("#db_id").val();
            $.getJSON(`/v1/db_config/${region}/${db_id}`, function (config) {
                for (const [key, value] of Object.entries(config)) {
                    let element = $(`#${key}`)
                    element.val(value);
                }
            })
        })

        function fill_select_picker(id, options) {
            const select = $(id);
            select.empty()
            options.forEach(function (key) {
                select.append(new Option(key, key))
            });
            select.selectpicker();
        }
    </script>
{% endblock %}
