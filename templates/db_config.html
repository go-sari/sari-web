{% extends "io_page.html" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css">
    <style type="text/css">
        .input-group-rds-password {
            margin-bottom: 2px!important;
        }
        .progress {
            height: 4px;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block jumbo_contents_top %}
    <p class="lead">Get the configuration parameters to access an RDS instance:</p>
    <form class="form-inline">
        <div class="row align-items-end">
            <div class="col-auto d-flex flex-column col-form-label-sm align-items-start">
                <label for="region">AWS Region:</label>
                <select id="region" class="form-control" data-width="auto">
                </select>
            </div>
            <div class="col-auto d-flex flex-column col-form-label-sm align-items-start">
                <label for="db_id">DB Identifier:</label>
                <select id="db_id" class="form-control" data-live-search="true" data-size="10"
                        data-width="auto">
                </select>
            </div>
            <div class="col-auto d-flex flex-column col-form-label-sm align-items-start">
                <label for="sel_db_name">Database:</label>
                <select id="sel_db_name" class="form-control" data-live-search="true" data-size="10"
                        data-width="auto">
                </select>
            </div>
            <div class="col-auto col-form-label-sm">
                <button id="get_config" type="button" class="btn btn-outline-success form-control">Get
                    Configuration
                </button>
            </div>
        </div>
    </form>
{% endblock %}

{% block jumbo_contents_bottom %}
    <div class="container">
        <form>
            {% for width, label, id_ in [
            (3, "SSH Hostname", "bh_hostname"),
            (3, "SSH Username", "bh_username"),
            (6, "RDS Hostname", "rds_hostname"),
            (2, "RDS Server Port", "rds_port"),
            (4, "Username", "rds_username"),
            (10, "Password", "rds_password"),
            (3, "Database", "db_name"),
            ] %}
                <div class="form-group row">
                    <label for="{{ id_ }}" class="col-sm-2 col-form-label font-weight-bold px-0 text-right">{{ label }}</label>

                    <div class="col-sm-{{ width }}">
                        <div class="input-group {{ ['input-group', id_] | join('-') | replace('_', '-') }} mb-3">
                            <input type="text" class="form-control d-inline-block text-truncate db-param" id="{{ id_ }}" readonly>
                            <button type="button" class="btn" data-clipboard-target="#{{ id_ }}"
                                    {# Use .form-control:disabled color. See definitions of $input-disabled-bg in: #}
                                    {# https://github.com/twbs/bootstrap/blob/main/scss/_variables.scss #}
                                    style="background-color: #e9ecef">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                        {% if id_ == "rds_password" %}
                            <div class="progress">
                                <div id="pwd_progress_bar" class="progress-bar" role="progressbar" style="width: 0%"
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"
            integrity="sha384-x8fxIWvLdZnkRaCvkDXOlxd6UP+qga975FjnbRp6NRpL9jjXjY9TwF9y7z4AccxS"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"
            integrity="sha384-x6nRSkfSsKGBsvlLFHHNju+buS3zYUztVnTRz/0JKgOIk3ulS6bNce/vHOvYE2eY"
            crossorigin="anonymous"></script>
    <script>
        let databases = null;
        let pwd_expires_msec = null;
        let pwd_expire_instant = null;
        let pwd_expire_timer = null;

        let clipboard = new ClipboardJS('.btn');
        clipboard.on("success", function (e) {
            e.clearSelection();
        })

        $(document).ready(function () {
            setup_pwd_progress_bar();
            load_databases();
        })

        $("#region").change(function () {
            fill_select_picker("#db_id", Object.keys(databases[$("#region").val()]).sort());
        })

        $("#db_id").change(function () {
            fill_select_picker("#sel_db_name", databases[$("#region").val()][$("#db_id").val()].sort());
            clear_db_parameters();
        })

        $("#sel_db_name").change(function () {
            let db_name = $("#db_name")
            if (db_name.val() !== "") {
                db_name.val($("#sel_db_name").val())
            }
        })

        $("#rds_password").change(function () {
            if (pwd_expire_timer != null) {
                clearInterval(pwd_expire_timer);
                pwd_expire_timer = null;
            }
            let that = this;
            let pb = $("#pwd_progress_bar");
            if (that.value === "") {
                pb.css("width", "0%");
                return;
            }
            pb.css("width", "100%");
            let amz_props = stsTokenAmzProperties(that.value)
            pwd_expires_msec = amz_props["X-Amz-Expires"] * 1000;
            pwd_expire_instant = moment(amz_props["X-Amz-Date"]).add(pwd_expires_msec, "milliseconds").valueOf()
            pwd_expire_timer = setInterval(function () {
                let percent = 100 * (pwd_expire_instant - moment().valueOf()) / pwd_expires_msec;
                if (percent <= 0) {
                    $("#rds_password").val('').change();
                } else {
                    $("#pwd_progress_bar").css("width", percent + "%");
                }
            }, 1000)
        })

        $("#get_config").click(function () {
            let region = $("#region").val();
            let db_id = $("#db_id").val();
            let db_name = $("#sel_db_name").val();
            {# It's not possible to prevent the HTML escaping inside the url_for() function. #}
            {# The workaround is to use replace() to unescape the delimiters. #}
            let url = `{{ url_for('get_db_configuration', region="${region}", db_identifier='${db_id}', db_name='${db_name}')
                          | replace("%24%7B", "${")
                          | replace("%7D", "}")}}`;
            $.getJSON(url, function (config) {
                for (const [key, value] of Object.entries(config)) {
                    $(`#${key}`).val(value).change();
                }
            })
        })

        function stsTokenAmzProperties(token) {
            return Object.assign({}, ...token.split('&')
                .filter(s => s.startsWith("X-Amz-"))
                .map(s => s.split("=", 2))
                .filter(pair => pair.length === 2)
                .map(pair => ({[pair[0]]: pair[1]}))
            );
        }

        function setup_pwd_progress_bar() {
            let pb = $("#pwd_progress_bar")
            pb.parent().css('width', $('#rds_password').css('width'))
        }

        function load_databases() {
            $.getJSON("{{ url_for('list_databases') }}", function (databases_) {
                databases = databases_;
                if ($.isEmptyObject(databases)) {
                    $.redirectPost("{{ url_for('farewell') }}", {
                        header1: "Oops!",
                        header2: "Sorry, but we couldn't find any RDS instance you are allowed to access on this AWS account.",
                        emoji: "confused"
                    })
                } else {
                    fill_select_picker("#region", Object.keys(databases).sort());
                }
            })
        }

        function fill_select_picker(id, options) {
            const select = $(id);
            select.empty()
            options.forEach(function (key) {
                select.append(new Option(key, key))
            });
            select.selectpicker('refresh');
            {# To force update the 'width' CSS attribute. #}
            select.trigger('loaded.bs.select');
            select.change();
        }

        function clear_db_parameters() {
            $(".db-param").val("").change();
        }

    </script>
{% endblock %}
